version: '2.1'

services:
  data-processor:
    container_name: 'data-processor-backend'
    build: .
    command: bash -c "mix deps.clean mime --build && mix deps.get && mix deps.compile && mix ecto.setup && mix phx.server"
    ports:
      - 4000:4000
    volumes:
      - ./:/opt/app
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - data-processor-postgres
    environment:
      DATABASE_HOST: data-processor-postgres
      SPARK_SCRIPTS_PATH: /opt/spark-utils/scripts
      STRATEGY_TO_USE: docker

  data-processor-postgres:
    container_name: data-processor-postgres
    image: 'postgres:10'
    ports:
      - 5432:5432
    environment:
      POSTGRES_USER: 'postgres'
      POSTGRES_PASSWORD: 'postgres'

  kafka:
    container_name: kafka
    image: 'spotify/kafka'
    ports:
      - 9092:9092
      - 2181:2181
    environment:
      ADVERTISED_HOST: 172.17.0.1

networks:
  default:
    external:
      name: platform
